---
- hosts: localhost
  vars:
  roles:
    -  role: infra-init
       tags: init
  tasks:
    - name: "Remove all known hosts from infra && swarm hosts -
            unless you want to be insecure this is the best comprermise ..."
      shell: "ssh-keygen -R {{ item.ip }}"
      with_items:
      - "{{ shelleg_hosts.infra }}"
      - "{{ shelleg_hosts.ci }}"
      - "{{ shelleg_hosts.swarm.swarm_managers }}"
      - "{{ shelleg_hosts.swarm.swarm_workers }}"
      ignore_errors: true
    - name: "Pausing for 7 secs to let Ansible get a grip of ssh connections ..."
      pause: seconds=7

- hosts: shelleg-infra-instances
  become: true
  vars:
    # optinally run nfs server ...
    #    nfs_mode: server
    ca_init: true
    ca_certify_nodes: true
    ca_fetch_keys: true
    ca_force_create: true
    ca_force_certify_nodes: true
    ca_distribute_keys: true
    # standalone docker daemon
    docker_single: true
  roles:
    - role: shelleg-common
      tags: always
    - role: apt-cacher-ng
      tags: core,apt
    - role: ntp
      tags: core,ntp
    - role: dnsmasq
      tags: core,dns
    - role: ca
      tags: ca
    - role: ansible-role-docker-swarm
      tags: core,swarm
    - role: docker-consul
      tags: core,consul
    - role: docker-registrator
      tags: core,registrator


#    - role: nfs
#      tags: init,nfs

#    - role: docker-registry
#    - role: ansible-role-docker-gogs
#      tags: gogs
#  tasks:
#    - name: "pull Docker Images Instead of downloading in realtime"
#      docker_image:
#        name: "{{ item.name }}:{{ item.tag }}"
#      with_items: "{{ docker_images }}"


